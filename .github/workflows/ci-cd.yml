name: Build & Deploy Python AI Backend to EC2 + CloudFront

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run tests (optional)
        run: |
          python -m pytest tests/ -v

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: python-ai-backend
          path: |
            src/
            requirements.txt
            app.py
            wsgi.py
            gunicorn.conf.py
            ecosystem.config.js

  deploy:
    runs-on: self-hosted
    needs: build

    steps:
      - name: Validate required secrets exist
        run: |
          if [ -z "${{ secrets.APP_SECRETS }}" ]; then
            echo "❌ ERROR: APP_SECRETS secret is required but not set"
            exit 1
          fi

      - name: Ensure Python and dependencies are installed
        run: |
          if ! command -v python3 >/dev/null; then
            echo "Installing Python..."
            sudo apt-get update
            sudo apt-get install -y python3 python3-pip python3-venv
          fi

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: python-ai-backend
          path: /home/ubuntu/ai-backend

      - name: Create virtual environment and install dependencies
        working-directory: /home/ubuntu/ai-backend
        run: |
          python3 -m venv venv
          source venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt
          deactivate

      - name: Create .env file from GitHub secret
        run: |
          sudo apt-get install -y jq
          echo '${{ secrets.APP_SECRETS }}' > /tmp/env.json
          if ! jq empty /tmp/env.json 2>/dev/null; then
            echo "❌ ERROR: APP_SECRETS is not valid JSON"
            exit 1
          fi
          jq -r 'to_entries|map("\(.key)=\(.value|tostring)")|.[]' /tmp/env.json > /home/ubuntu/ai-backend/.env

      - name: Install and configure Gunicorn
        run: |
          if ! command -v gunicorn >/dev/null; then
            echo "Installing Gunicorn..."
            sudo apt-get install -y gunicorn
          fi

      - name: Restart application with PM2
        working-directory: /home/ubuntu/ai-backend
        run: |
          pm2 restart ai-backend || pm2 start gunicorn --name "ai-backend" -- \
            --bind 0.0.0.0:8000 \
            --workers 4 \
            --timeout 120 \
            --access-logfile - \
            --error-logfile - \
            app:app
          pm2 save

      - name: Setup systemd service (as alternative)
        run: |
          cat << 'EOF' | sudo tee /etc/systemd/system/ai-backend.service
          [Unit]
          Description=Python AI Backend
          After=network.target

          [Service]
          User=ubuntu
          Group=ubuntu
          WorkingDirectory=/home/ubuntu/ai-backend
          Environment=PYTHONPATH=/home/ubuntu/ai-backend
          EnvironmentFile=/home/ubuntu/ai-backend/.env
          ExecStart=/home/ubuntu/ai-backend/venv/bin/gunicorn \
          --bind 0.0.0.0:8000 \
          --workers 4 \
          --timeout 120 \
          --access-logfile - \
          --error-logfile - \
            app:app

          Restart=always
          RestartSec=5

          [Install]
          WantedBy=multi-user.target
           EOF

          sudo systemctl daemon-reload
          sudo systemctl enable ai-backend
          echo "Systemd service created. Run 'sudo systemctl restart ai-backend' to start."

  cloudfront:
    runs-on: ubuntu-latest
    needs: deploy


    steps:
      - name: Validate CloudFront secrets exist
        run: |
          if [ -z "${{ secrets.AWS_ACCESS_KEY_ID }}" ]; then
            echo "❌ ERROR: AWS_ACCESS_KEY_ID secret is required but not set"
            exit 1
          fi
          if [ -z "${{ secrets.AWS_SECRET_ACCESS_KEY }}" ]; then
            echo "❌ ERROR: AWS_SECRET_ACCESS_KEY secret is required but not set"
            exit 1
          fi
          if [ -z "${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}" ]; then
            echo "❌ ERROR: CLOUDFRONT_DISTRIBUTION_ID secret is required but not set"
            exit 1
          fi

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Invalidate CloudFront cache
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ secrets.CLOUDFRONT_ID }} \
            --paths "/*"