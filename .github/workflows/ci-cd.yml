name: Build & Deploy Python AI Backend to EC2 + CloudFront

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
          cache: pip

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Prepare deployment package
        run: |
          mkdir -p deployment-package
          # Copy everything except venv, git, CI config, etc.
          rsync -av --exclude='.git' \
                   --exclude='.github' \
                   --exclude='venv' \
                   --exclude='__pycache__' \
                   --exclude='*.pyc' \
                   ./ deployment-package/
          # Ensure Node files are included
          cp -f package.json deployment-package/ || true
          cp -f package-lock.json deployment-package/ || true
          cp -f yarn.lock deployment-package/ || true
          echo "‚úÖ Deployment package prepared (Python + Node support)"
          ls -la deployment-package

      - name: Upload deployment artifact
        uses: actions/upload-artifact@v4
        with:
          name: python-ai-backend
          path: deployment-package/

  deploy:
    runs-on: self-hosted
    needs: build
    timeout-minutes: 15

    steps:
      - name: Validate required secrets
        run: |
          if [ -z "${{ secrets.APP_SECRETS }}" ]; then
            echo "‚ùå ERROR: APP_SECRETS secret is required but not set"
            exit 1
          fi

      - name: Ensure Python + venv tools installed
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 python3-pip python3-venv python3-setuptools python3-wheel jq
          python3 --version
          pip3 --version

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: python-ai-backend
          path: /home/ubuntu/app

      - name: Copy files into runner workspace
        run: |
          mkdir -p ~/actions-runner/_work/ai-backend/ai-backend
          cp -r /home/ubuntu/app/* ~/actions-runner/_work/ai-backend/ai-backend/
          echo "‚úÖ Files copied to runner workspace"
          ls -la ~/actions-runner/_work/ai-backend/ai-backend

      - name: Set up application directory
        run: |
          sudo mkdir -p /var/log/ai-backend
          sudo chown -R ubuntu:ubuntu /home/ubuntu/app /var/log/ai-backend

      - name: Create and activate virtual environment
        working-directory: /home/ubuntu/app
        run: |
          python3 -m venv venv
          source venv/bin/activate
          pip install --upgrade pip wheel setuptools
          pip install -r requirements.txt
          pip install gunicorn
          deactivate

      - name: Create .env file from secrets
        working-directory: /home/ubuntu/app
        run: |
          echo '${{ secrets.APP_SECRETS }}' > /tmp/app_secrets.txt

          if jq empty /tmp/app_secrets.txt 2>/dev/null; then
            jq -r 'to_entries|map("\(.key)=\(.value|tostring)")|.[]' /tmp/app_secrets.txt > .env
          else
            cat /tmp/app_secrets.txt > .env
          fi

          chmod 600 .env
          echo "‚úÖ .env file created successfully"

      - name: Detect app entrypoint
        id: detect_entrypoint
        working-directory: /home/ubuntu/app
        run: |
          if [ -f "wsgi.py" ]; then
            echo "entrypoint=wsgi:app" >> $GITHUB_OUTPUT
          elif [ -f "app.py" ]; then
            echo "entrypoint=app:app" >> $GITHUB_OUTPUT
          elif [ -f "main.py" ]; then
            echo "entrypoint=main:app" >> $GITHUB_OUTPUT
          else
            echo "‚ùå ERROR: No entrypoint found (expected main.py, app.py, or wsgi.py)"
            exit 1
          fi

      - name: Create systemd service
        run: |
          ENTRYPOINT="${{ steps.detect_entrypoint.outputs.entrypoint }}"
          cat << EOF | sudo tee /etc/systemd/system/ai-backend.service
          [Unit]
          Description=Python AI Backend Service
          After=network.target
          Requires=network.target

          [Service]
          Type=simple
          User=ubuntu
          Group=ubuntu
          WorkingDirectory=/home/ubuntu/app
          Environment=PYTHONPATH=/home/ubuntu/app
          EnvironmentFile=/home/ubuntu/app/.env
          ExecStart=/home/ubuntu/app/venv/bin/gunicorn \\
            --bind 0.0.0.0:8000 \\
            --workers 4 \\
            --timeout 120 \\
            --access-logfile /var/log/ai-backend/access.log \\
            --error-logfile /var/log/ai-backend/error.log \\
            --capture-output \\
            --log-level debug \\
            \$ENTRYPOINT
          Restart=always
          RestartSec=5
          SyslogIdentifier=ai-backend

          [Install]
          WantedBy=multi-user.target
          EOF

      - name: Reload and enable systemd service
        run: |
          sudo systemctl daemon-reload
          sudo systemctl enable ai-backend.service

      - name: Restart application service
        run: |
          sudo systemctl restart --no-block ai-backend.service
          sleep 5
          sudo systemctl status ai-backend.service --no-pager -l || true
          echo "Check logs with: sudo journalctl -u ai-backend -n 50 --no-pager"
          echo "Or check: /var/log/ai-backend/error.log"

  cloudfront:
    runs-on: ubuntu-latest
    needs: deploy
    if: always() && needs.deploy.result == 'success'

    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION || 'us-east-1' }}

      - name: Validate CloudFront configuration
        run: |
          if [ -z "${{ secrets.CLOUDFRONT_ID }}" ]; then
            echo "‚ö†Ô∏è CLOUDFRONT_ID secret not set, skipping CloudFront invalidation"
            exit 0
          fi

      - name: Invalidate CloudFront cache
        run: |
          echo "üöÄ Invalidating CloudFront cache for distribution: ${{ secrets.CLOUDFRONT_ID }}"
          aws cloudfront create-invalidation \
            --distribution-id ${{ secrets.CLOUDFRONT_ID }} \
            --paths "/*"
          echo "‚úÖ CloudFront cache invalidation initiated"

  cleanup:
    runs-on: ubuntu-latest
    needs: [build, deploy, cloudfront]
    if: always()

    steps:
      - name: Cleanup workflow summary
        run: |
          echo "üèÅ Workflow completed"
          echo "Build: ${{ needs.build.result }}"
          echo "Deploy: ${{ needs.deploy.result }}"
          echo "CloudFront: ${{ needs.cloudfront.result }}"
