name: Build & Deploy Python AI Backend to EC2 + CloudFront

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
          cache: pip

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install test dependencies
        run: |
          pip install pytest

      - name: Run tests if they exist
        run: |
          if [ -d "tests" ] && [ -n "$(find tests -name 'test_*.py' -o -name '*_test.py')" ]; then
            echo "Running tests..."
            pytest tests/ -v
          else
            echo "⚠️  No test files found in tests/ directory, skipping tests"
          fi

      - name: Create deployment package
        run: |
          mkdir -p deployment-package
          cp -r src/ requirements.txt app.py wsgi.py gunicorn.conf.py deployment-package/
          # Include tests directory if it exists for debugging
          if [ -d "tests" ]; then
            cp -r tests/ deployment-package/
          fi

      - name: Upload deployment artifact
        uses: actions/upload-artifact@v4
        with:
          name: python-ai-backend
          path: deployment-package/

  deploy:
    runs-on: self-hosted
    needs: build
    timeout-minutes: 10

    steps:
      - name: Validate required secrets
        run: |
          if [ -z "${{ secrets.APP_SECRETS }}" ]; then
            echo "❌ ERROR: APP_SECRETS secret is required but not set"
            exit 1
          fi

      - name: Check Python installation
        run: |
          if ! command -v python3 >/dev/null; then
            echo "Installing Python..."
            sudo apt-get update
            sudo apt-get install -y python3 python3-pip python3-venv
          fi
          python3 --version

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: python-ai-backend
          path: /home/ubuntu/ai-backend

      - name: Set up application directory
        run: |
          sudo chown -R ubuntu:ubuntu /home/ubuntu/ai-backend
          cd /home/ubuntu/ai-backend

      - name: Create and activate virtual environment
        working-directory: /home/ubuntu/ai-backend
        run: |
          python3 -m venv venv
          source venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt
          deactivate

      - name: Create .env file from secrets
        working-directory: /home/ubuntu/ai-backend
        run: |
          # Install jq for JSON parsing
          if ! command -v jq >/dev/null; then
            sudo apt-get update
            sudo apt-get install -y jq
          fi
          
          echo '${{ secrets.APP_SECRETS }}' > /tmp/env.json
          if ! jq empty /tmp/env.json 2>/dev/null; then
            echo "❌ ERROR: APP_SECRETS is not valid JSON"
            exit 1
          fi
          
          jq -r 'to_entries|map("\(.key)=\(.value|tostring)")|.[]' /tmp/env.json > .env
          chmod 600 .env
          echo "✅ .env file created successfully"

      - name: Create systemd service
        run: |
          cat << 'EOF' | sudo tee /etc/systemd/system/ai-backend.service
          [Unit]
          Description=Python AI Backend Service
          After=network.target
          Requires=network.target

          [Service]
          Type=simple
          User=ubuntu
          Group=ubuntu
          WorkingDirectory=/home/ubuntu/ai-backend
          Environment=PYTHONPATH=/home/ubuntu/ai-backend
          EnvironmentFile=/home/ubuntu/ai-backend/.env
          ExecStart=/home/ubuntu/ai-backend/venv/bin/gunicorn \
            --bind 0.0.0.0:8000 \
            --workers 4 \
            --timeout 120 \
            --access-logfile - \
            --error-logfile - \
            --capture-output \
            --log-level info \
            app:app
          ExecReload=/bin/kill -s HUP $MAINPID
          ExecStop=/bin/kill -s TERM $MAINPID
          Restart=always
          RestartSec=5
          StandardOutput=syslog
          StandardError=syslog
          SyslogIdentifier=ai-backend

          [Install]
          WantedBy=multi-user.target
          EOF

      - name: Reload and enable systemd service
        run: |
          sudo systemctl daemon-reload
          sudo systemctl enable ai-backend.service

      - name: Restart application service
        run: |
          sudo systemctl restart ai-backend.service
          sleep 5
          sudo systemctl status ai-backend.service --no-pager -l
          echo "✅ Application service deployed and started"

      - name: Verify application health
        run: |
          echo "Waiting for application to start..."
          sleep 10
          if curl -f http://localhost:8000/health >/dev/null 2>&1; then
            echo "✅ Application is healthy and responding"
          else
            echo "⚠️  Health check failed, but service might still be starting"
            # Don't fail the deployment for health check to allow for warm-up time
          fi

  cloudfront:
    runs-on: ubuntu-latest
    needs: deploy
    if: always() && needs.deploy.result == 'success'

    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION || 'us-east-1' }}

      - name: Validate CloudFront configuration
        run: |
          if [ -z "${{ secrets.CLOUDFRONT_ID }}" ]; then
            echo "⚠️  CLOUDFRONT_ID secret not set, skipping CloudFront invalidation"
            exit 0
          fi

      - name: Invalidate CloudFront cache
        run: |
          echo "Invalidating CloudFront cache for distribution: ${{ secrets.CLOUDFRONT_ID }}"
          aws cloudfront create-invalidation \
            --distribution-id ${{ secrets.CLOUDFRONT_ID }} \
            --paths "/*" \
            --output json
          echo "✅ CloudFront cache invalidation initiated"

  cleanup:
    runs-on: ubuntu-latest
    needs: [build, deploy, cloudfront]
    if: always()

    steps:
      - name: Cleanup workflow
        run: |
          echo "Workflow completed with status:"
          echo "Build: ${{ needs.build.result }}"
          echo "Deploy: ${{ needs.deploy.result }}"
          echo "CloudFront: ${{ needs.cloudfront.result }}"